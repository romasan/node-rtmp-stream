function e(e){return e&&e.__esModule?e.default:e}var t,r,n,s,a=globalThis,l={},o={},i=a.parcelRequire8661;null==i&&((i=function(e){if(e in l)return l[e].exports;if(e in o){var t=o[e];delete o[e];var r={id:e,exports:{}};return l[e]=r,t.call(r.exports,r,r.exports),r.exports}var n=Error("Cannot find module '"+e+"'");throw n.code="MODULE_NOT_FOUND",n}).register=function(e,t){o[e]=t},a.parcelRequire8661=i),i.register;var c=i("iM5HV");i("fYo6y");var u=i("b2S2j"),c=i("iM5HV"),d=i("fYo6y"),f=i("PTcTU"),x=i("fvstS"),h=i("g7WMx"),m=i("5Ml5F"),g=i("hasHI"),p=i("ifBWf"),v=i("cu5bI");(t=r||(r={})).PIXEL="PIXEL",t.TIME="TIME";var c=i("iM5HV");i("fYo6y");var w=e=>(0,c.jsx)("svg",{viewBox:"171.843 150.662 31.29 36.901",xmlns:"http://www.w3.org/2000/svg",...e,children:(0,c.jsx)("path",{d:"m220.246 153.468 18.82 31.29h-36.901l18.081-31.29Z",style:{transformOrigin:"220.615px 169.113px"},transform:"rotate(90 -16.564 -16.564)"})}),c=i("iM5HV");i("fYo6y");var j=e=>(0,c.jsx)("svg",{viewBox:"171.724 150.559 31.496 37.164",xmlns:"http://www.w3.org/2000/svg",...e,children:(0,c.jsx)("path",{d:"M171.724 150.713h10.565v37.01h-10.565zm20.931-.154h10.565v37.01h-10.565z"})}),c=i("iM5HV");i("fYo6y");var y=e=>(0,c.jsxs)("svg",{viewBox:"171.724 150.559 62.416 37.164",xmlns:"http://www.w3.org/2000/svg",...e,children:[(0,c.jsx)("path",{d:"m220.246 153.468 18.82 31.29h-36.901l18.081-31.29Z",style:{transformOrigin:"220.615px 169.113px"},transform:"rotate(90 -16.564 -16.564)"}),(0,c.jsx)("path",{d:"m220.246 153.468 18.82 31.29h-36.901l18.081-31.29Z",style:{transformOrigin:"220.615px 169.113px"},transform:"rotate(90 -1.07 -1.05)"})]}),c=i("iM5HV");i("fYo6y");var M=e=>(0,c.jsxs)("svg",{viewBox:"171.724 150.559 62.415 37.164",xmlns:"http://www.w3.org/2000/svg",...e,children:[(0,c.jsx)("path",{d:"m220.246 153.468 18.82 31.29h-36.901l18.081-31.29Z",style:{transformOrigin:"220.615px 169.113px"},transform:"matrix(0 1 1 0 -2.24 0)"}),(0,c.jsx)("path",{d:"m220.246 153.468 18.82 31.29h-36.901l18.081-31.29Z",style:{transformOrigin:"220.615px 169.113px"},transform:"matrix(0 1 1 0 -33.246 .02)"})]});n="gWqsmq_button",s="gWqsmq_vDelimiter";const S=(e,t)=>{let r=e.expands.filter(e=>e.index.from<=t).length-1,n=e.expands[r],s=Math.floor((t-n.index.from+1)/e.partSize),a=e.expands.slice(0,r).reduce((e,t)=>e+(t.part.to-t.part.from+1),0)+s;return{expandIndex:r,partIndex:s,globalPartIndex:a,expand:n}},E=async(e,t)=>{let r=[];try{let n=await (0,m.fetchTimelapsePartBin)(e,t),s=await n.arrayBuffer(),a=await (0,p.gzipAB)(s),l=new Uint16Array(a.buffer),o=[];l.forEach(e=>{o.push(e),3===o.length&&(r.push(o),o=[])})}catch(e){console.log("Error:",e)}return r},I=(e,t,r)=>{let n=e.getContext("2d"),s=document.createElement("canvas"),a=s.getContext("2d");s.width=e.width,s.height=e.height,a.drawImage(e,0,0),e.width=t,e.height=r,n.fillStyle="#ffffff",n.fillRect(0,0,t,r),n.drawImage(s,0,0)};var m=i("5Ml5F"),q=i("d165e");(0,m.start)().then(e=>{if("fail"===e){document.location.reload();return}(0,q.connect)()}).catch(()=>{}),(0,u.createRoot)(document.getElementById("root")).render((0,c.jsx)(()=>{let[t,a]=(0,d.useState)([]),[l,o]=(0,d.useState)(""),[i,u]=(0,d.useState)({}),[q,R]=(0,d.useState)(15e3),N=(0,d.useRef)(q),b=(0,d.useRef)(null),C=(0,d.useRef)({fillRect:()=>null}),$=(0,d.useRef)(!1),[_,W]=(0,d.useState)(!1),P=(0,d.useRef)(0),k=(0,d.useRef)(0),[B,H]=(0,d.useState)(0),O=(0,d.useRef)([]),L=(0,d.useRef)(null),z=(0,d.useRef)(null),T=(0,d.useRef)(0),F=(0,d.useRef)(-1),X=(0,d.useRef)(()=>{}),D=(0,d.useRef)(()=>{}),[V,Y]=(0,d.useState)(-1),[A,Z]=(0,d.useState)(-1),[U,G]=(0,d.useState)(""),[J,K]=(0,d.useState)(r.PIXEL),Q=(0,d.useMemo)(()=>l?`${m.staticHost}/timelapse/${l}/${B}.png`:"",[l,B]),ee=(0,d.useMemo)(()=>{let{width:e}=L.current?L.current.getBoundingClientRect():{};return(e-3)/i.total},[i]),{wsStore:et,isAuthorized:er,isOnline:en,hasNewMessage:es,setHasNewMessage:ea}=(0,v.useWsStore)(),el=e(x)(),eo=(0,g.useModal)({content:(0,c.jsx)(h.Login,{}),width:"300px"}),ei=async()=>{try{let e=await (0,m.fetchTimelapse)(l);u(e)}catch(e){}},ec=async e=>{O.current[e]||(O.current[e]=!0,O.current[e]=await E(l,e),Y(e))},eu=()=>{z.current&&(z.current.style.width=`${k.current*ee}px`)},ed=()=>{P.current=Date.now(),$.current=!0,W(!0),ex()},ef=()=>{$.current=!1,W(!1)},ex=()=>{if(!$.current||!i.expands)return;let e=Date.now()-P.current;if(e){let t=Math.floor(N.current/1e3*e);eu();let{expandIndex:r,partIndex:n,globalPartIndex:s,expand:a}=S(i,k.current),l=a.index.from+n*i.partSize,o=Math.min(a.index.to-1,l+i.partSize-1),c=i.expands[r-1],u=(c&&c.index.to||0)+n*i.partSize;s<=i.totalParts-1&&!O.current[s+1]&&ec(s+1);let d=o-k.current;d<t&&(t=d),F.current!==r&&(F.current=r,r&&(I(b.current,a.canvas.width,a.canvas.height),X.current()));for(let e=0;e<t;e++){let t=k.current-u+e;try{if(t>=0){let[e,r,n]=O.current[s][t];C.current.fillStyle=i.colors[e],C.current.fillRect(r,n,1,1),T.current=T.current+1}}catch(e){console.log("Error:",e,t)}}k.current=k.current+(t<=0?1:t)}if(P.current=Date.now(),k.current>=i.total-1){ef();return}requestAnimationFrame(ex)},eh=()=>{if(!i.expands||$.current)return;let{partIndex:e,globalPartIndex:t,expand:r}=S(i,k.current),n=k.current-(r.index.from+e*i.partSize);D.current();for(let e=0;e<n;e++)try{let[r,n,s]=O.current[t][e];C.current.fillStyle=i.colors[r],C.current.fillRect(n,s,1,1)}catch(e){console.log("Error:",e);return}},em=()=>{$.current?ef():ed()};return(0,d.useEffect)(()=>{i&&i.episode===l&&O.current[B]&&O.current[B].length&&eh()},[B,l,i,V,A]),(0,d.useEffect)(()=>{l&&(ef(),k.current=0,O.current=[],H(0),ec(0),ei(),eu())},[l]),(0,d.useEffect)(()=>{N.current=q},[q]),(0,d.useEffect)(()=>{let e=e=>{32===e.keyCode&&em()};return document.body.addEventListener("keyup",e),()=>{document.body.removeEventListener("keyup",e)}},[i]),(0,d.useEffect)(()=>{let e=setInterval(()=>{if(J===r.PIXEL)G(`${(0,p.formatNumber)(k.current?k.current+1:0)} / ${i?(0,p.formatNumber)(i.total||0):0} pix`);else{let e=Math.floor(k.current/q),t=Math.floor(i.total/q),r=k.current?`${String(Math.floor(e/60)).padStart(2,"0")}:${String(e%60).padStart(2,"0")}`:"00:00",n=i?`${String(Math.floor(t/60)).padStart(2,"0")}:${String(t%60).padStart(2,"0")}`:"00:00";G(`${r} / ${n}`)}},300);return()=>{clearInterval(e)}},[i,J,q]),(0,d.useEffect)(()=>{(0,m.fetchTimelapseSeasons)().then(e=>{a(e.seasons),o(e.seasons[e.seasons.length-1].key)}).catch(()=>{})},[]),(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)("div",{className:e(f)("gWqsmq_root",{mobile:el}),children:[(0,c.jsx)(h.HeaderLogo,{}),(0,c.jsx)(h.HeaderControls,{isAuthorized:er,name:et?et.name:"",isOnline:en,hasNewMessage:es,setHasNewMessage:ea,login:eo.open,role:g.ERole.user}),(0,c.jsx)(h.Canvas,{color:"",isOnline:en,onInit:({image:e,centering:t,resetImage:r})=>{b.current=e,C.current=e&&e.getContext&&e.getContext("2d"),X.current=t,D.current=r},viewOnly:!0,src:Q}),(0,c.jsxs)("div",{className:"gWqsmq_bar",children:[(0,c.jsx)("div",{className:"gWqsmq_timelapse",ref:L,onClick:e=>{if(!i.expands)return;let{width:t,left:r}=L.current?L.current.getBoundingClientRect():{},n=Math.floor((e.clientX-r)/t*i.total),{globalPartIndex:s}=S(i,n);ef(),k.current=n,Z(n),eu(),H(s),ec(s)},children:(()=>{if(!L.current&&!i.total)return null;let{width:t}=L.current.getBoundingClientRect(),r=t/i.total;return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("div",{ref:z,className:"gWqsmq_progress"},"progress"),i.expands&&i.expands.slice(1).map(t=>(0,c.jsx)(c.Fragment,{children:(0,c.jsx)("div",{className:e(f)("gWqsmq_position","gWqsmq_positionExpand"),style:{left:`${Math.floor(t.index.from*r)}px`}},`${t.index.from}-${t.index.to}`)}))]})})()}),(0,c.jsxs)("div",{className:"gWqsmq_controls",children:[(0,c.jsxs)("div",{className:"gWqsmq_leftControls",children:[(0,c.jsx)("button",{className:n,onClick:em,children:_?(0,c.jsx)(j,{}):(0,c.jsx)(w,{})}),(0,c.jsx)("div",{className:s}),(0,c.jsx)("button",{className:n,onClick:()=>{R(e=>Math.floor(e/1.1))},children:(0,c.jsx)(M,{})}),(0,c.jsx)("button",{className:n,onClick:()=>{R(e=>Math.floor(1.1*e))},children:(0,c.jsx)(y,{})}),Number((q/15e3).toFixed(2)),"X",(0,c.jsx)("div",{className:s}),(0,c.jsx)("span",{className:"gWqsmq_cursor",onClick:()=>K(e=>e===r.PIXEL?r.TIME:r.PIXEL),children:U})]}),(0,c.jsxs)("div",{children:["Сезон:",(0,c.jsxs)("select",{onChange:e=>{o(e.target.value)},children:[t.map((e,t,{length:r})=>e.delimiter?(0,c.jsx)("hr",{},e.key):(0,c.jsx)("option",{value:e.key,selected:t===r-1,children:e.label},e.key)),0===t.length&&(0,c.jsx)("option",{children:"Загрузка..."})]})]})]})]})]}),eo.render()]})},{}));