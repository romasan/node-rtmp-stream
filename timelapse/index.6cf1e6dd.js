function e(e){return e&&e.__esModule?e.default:e}var t,r=globalThis,n={},s={},a=r.parcelRequire8661;null==a&&((a=function(e){if(e in n)return n[e].exports;if(e in s){var t=s[e];delete s[e];var r={id:e,exports:{}};return n[e]=r,t.call(r.exports,r,r.exports),r.exports}var a=Error("Cannot find module '"+e+"'");throw a.code="MODULE_NOT_FOUND",a}).register=function(e,t){s[e]=t},r.parcelRequire8661=a),(0,a.register)("cu5bI",function(e,t){Object.defineProperty(e.exports,"useWsStore",{get:()=>s,set:void 0,enumerable:!0,configurable:!0});var r=a("fYo6y"),n=a("7Y5nT");let s=()=>{let[e,t]=(0,r.useState)({name:"",palette:null}),[s,a]=(0,r.useState)(!1),[o,l]=(0,r.useState)(0),[u,c]=(0,r.useState)(!1),[i,d]=(0,r.useState)(0),[f,x]=(0,r.useState)(!1),h=e=>{t((t={})=>({...t,...e})),l(Date.now()+e.countdown),a(e.isAuthorized),"newer"!==e.finish&&d(Date.now()+e.finish)},g=e=>{t((t={})=>({...t,countdown:e})),l(Date.now()+e)},p=e=>{c(e)},m=t=>{e.name&&t.text.indexOf(`@${e.name}`)>=0&&x(!0)};return(0,r.useEffect)(()=>((0,n.default).on("ws:init",h),(0,n.default).on("ws:countdown",g),(0,n.default).on("ws:connect",p),(0,n.default).on("ws:chatMessage",m),()=>{(0,n.default).off("ws:init",h),(0,n.default).off("ws:countdown",g),(0,n.default).off("ws:connect",p)}),[s]),{wsStore:e,isAuthorized:s,expiration:o,isOnline:u,finish:i,hasNewMessage:f,setHasNewMessage:x}}});var o=a("iM5HV");a("fYo6y");var l=a("b2S2j"),o=a("iM5HV"),u=a("fYo6y"),c=a("PTcTU"),i=a("fvstS"),d=a("g7WMx"),f=a("5Ml5F"),x=a("ifBWf"),h=a("cu5bI");t="gWqsmq_button";const g=(e,t)=>{let r=e.expands.filter(e=>e.index.from<=t).length-1,n=e.expands[r],s=Math.floor((t-n.index.from+1)/e.partSize),a=e.expands.slice(0,r).reduce((e,t)=>e+(t.part.to-t.part.from+1),0)+s;return{expandIndex:r,partIndex:s,globalPartIndex:a,expand:n}},p=async(e,t)=>{let r=[];try{let n=await (0,f.fetchTimelapsePartBin)(e,t),s=await n.arrayBuffer(),a=await (0,x.gzipAB)(s),o=new Uint16Array(a.buffer),l=[];o.forEach(e=>{l.push(e),3===l.length&&(r.push(l),l=[])})}catch(e){console.log("Error:",e)}return r},m=(e,t,r)=>{let n=e.getContext("2d"),s=document.createElement("canvas"),a=s.getContext("2d");s.width=e.width,s.height=e.height,a.drawImage(e,0,0),e.width=t,e.height=r,n.fillStyle="#ffffff",n.fillRect(0,0,t,r),n.drawImage(s,0,0)};var f=a("5Ml5F"),w=a("d165e");(0,f.start)().then(e=>{if("fail"===e){document.location.reload();return}(0,w.connect)()}).catch(()=>{}),(0,l.createRoot)(document.getElementById("root")).render(/*#__PURE__*/(0,o.jsx)(()=>{let[r,n]=(0,u.useState)("s1e2"),[s,a]=(0,u.useState)({}),[l,x]=(0,u.useState)(15e3),w=(0,u.useRef)(l),S=(0,u.useRef)(null),v=(0,u.useRef)({fillRect:()=>null}),y=(0,u.useRef)(!1),[M,R]=(0,u.useState)(!1),b=(0,u.useRef)(0),j=(0,u.useRef)(0),[q,E]=(0,u.useState)(0),I=(0,u.useRef)({}),N=(0,u.useRef)(null),C=(0,u.useRef)(null),W=(0,u.useRef)(0),_=(0,u.useRef)(-1),z=(0,u.useRef)(()=>{}),O=(0,u.useRef)(()=>{}),[D,P]=(0,u.useState)(-1),[A,B]=(0,u.useState)(-1),$=(0,u.useMemo)(()=>`${f.APIhost}/timelapse/${r}/${q}.png`,[r,q]),k=(0,u.useMemo)(()=>{let{width:e}=N.current?N.current.getBoundingClientRect():{};return e/s.total},[s]),{wsStore:T,isAuthorized:F,isOnline:H,hasNewMessage:U,setHasNewMessage:Y}=(0,h.useWsStore)(),L=/*@__PURE__*/e(i)(),V=async()=>{try{let e=await (0,f.fetchTimelapse)(r);a(e)}catch(e){}},X=async e=>{I.current[e]||(I.current[e]=!0,I.current[e]=await p(r,e),P(e))},G=()=>{if(!y.current||!s.expands)return;let e=Date.now()-b.current;if(e){let t=Math.floor(w.current/1e3*e);J();let{expandIndex:r,partIndex:n,globalPartIndex:a,expand:o}=g(s,j.current),l=o.index.from+n*s.partSize,u=Math.min(o.index.to-1,l+s.partSize-1),c=s.expands[r-1],i=(c&&c.index.to||0)+n*s.partSize;a<=s.totalParts-1&&!I.current[a+1]&&X(a+1);let d=u-j.current;d<t&&(t=d),_.current!==r&&(_.current=r,r&&(m(S.current,o.canvas.width,o.canvas.height),z.current()));for(let e=0;e<t;e++){let t=j.current-i+e;try{if(t>=0){let[e,r,n]=I.current[a][t];v.current.fillStyle=s.colors[e],v.current.fillRect(r,n,1,1),W.current=W.current+1}}catch(e){console.log("Error:",e,t)}}j.current=j.current+(t<=0?1:t)}if(b.current=Date.now(),j.current>=s.total-1){Q();// playCursor.current = 0;
// moveTimelapseCursor();
return}requestAnimationFrame(G)},J=()=>{C.current&&(C.current.style.width=`${j.current*k}px`)},K=()=>{b.current=Date.now(),y.current=!0,R(!0),G()},Q=()=>{y.current=!1,R(!1)},Z=()=>{y.current?Q():K()},ee=()=>{if(!s.expands||y.current)return;let{partIndex:e,globalPartIndex:t,expand:r}=g(s,j.current),n=j.current-(r.index.from+e*s.partSize);O.current();for(let e=0;e<n;e++)try{let[r,n,a]=I.current[t][e];v.current.fillStyle=s.colors[r],v.current.fillRect(n,a,1,1)}catch(e){console.log("Error:",e);return}};return(0,u.useEffect)(()=>{s&&s.episode===r&&I.current[q]&&I.current[q].length&&ee()},[q,r,s,D,A]),(0,u.useEffect)(()=>{r&&(Q(),j.current=0,I.current=[],E(0),X(0),V(),J())},[r]),(0,u.useEffect)(()=>{w.current=l},[l]),(0,u.useEffect)(()=>{let e=e=>{32===e.keyCode&&Z()};return document.body.addEventListener("keyup",e),()=>{document.body.removeEventListener("keyup",e)}},[s]),/*#__PURE__*/(0,o.jsxs)("div",{className:/*@__PURE__*/e(c)("gWqsmq_root",{mobile:L}),children:[/*#__PURE__*/(0,o.jsx)(d.Header,{isAuthorized:F,name:T?T.name:"",isOnline:H,hasNewMessage:U,setHasNewMessage:Y}),/*#__PURE__*/(0,o.jsx)(d.Canvas,{color:"",isOnline:H,onInit:({image:e,centering:t,resetImage:r})=>{S.current=e,v.current=e&&e.getContext&&e.getContext("2d"),z.current=t,O.current=r},viewOnly:!0,src:$}),/*#__PURE__*/(0,o.jsxs)("div",{className:"gWqsmq_controls",children:[/*#__PURE__*/(0,o.jsxs)("select",{onChange:e=>{n(e.target.value)},children:[/*#__PURE__*/(0,o.jsx)("option",{value:"s1e1",children:"S1E1"}),/*#__PURE__*/(0,o.jsx)("option",{value:"s1e2",selected:!0,children:"S1E2"})]}),/*#__PURE__*/(0,o.jsx)("button",{className:t,onClick:Z,children:M?"⏸":"⏵"}),/*#__PURE__*/(0,o.jsx)("div",{className:"gWqsmq_vDelimiter"}),/*#__PURE__*/(0,o.jsx)("button",{className:t,onClick:()=>{x(e=>Math.floor(e/1.1))},children:"–"}),/*#__PURE__*/(0,o.jsx)("button",{className:t,onClick:()=>{x(e=>Math.floor(1.1*e))},children:"+"}),"speed: ",l," pix per sec"]}),/*#__PURE__*/(0,o.jsx)("div",{className:"gWqsmq_timelapse",ref:N,onClick:e=>{if(!s.expands)return;let{width:t,left:r}=N.current?N.current.getBoundingClientRect():{},n=Math.floor((e.clientX-r)/t*s.total),{globalPartIndex:a}=g(s,n);Q(),j.current=n,B(n),J(),E(a),X(a)},children:(()=>{if(!N.current&&!s.total)return null;let{width:t}=N.current.getBoundingClientRect(),r=t/s.total;return/*#__PURE__*/(0,o.jsxs)(o.Fragment,{children:[s.expands&&s.expands.map(t=>/*#__PURE__*/(0,o.jsx)(o.Fragment,{children:/*#__PURE__*/(0,o.jsx)("div",{className:/*@__PURE__*/e(c)("gWqsmq_position","gWqsmq_positionExpand"),style:{left:`${Math.floor(t.index.from*r)}px`}},`${t.index.from}-${t.index.to}`)})),/*#__PURE__*/(0,o.jsx)("div",{ref:C,className:"gWqsmq_progress"},"progress")]})})()})]})},{}));